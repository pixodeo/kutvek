# Documentation des Modules - Kutvek Platform

## üìã Vue d'ensemble

La plateforme Kutvek est organis√©e en modules fonctionnels ind√©pendants, chacun g√©rant un domaine m√©tier sp√©cifique. Cette architecture modulaire facilite la maintenance et l'√©volution du syst√®me.

### Modules disponibles

- **Product** - Gestion des produits g√©n√©riques
- **Cart** - Panier d'achat
- **Checkout** - Processus de commande
- **SaddleCover** - Housses de selle pour v√©hicules
- **Sportswear** - V√™tements personnalis√©s
- **Vehicle** - Catalogue de v√©hicules
- **Page** - Syst√®me CMS pour pages de contenu
- **Category** - Cat√©gories de produits
- **Catalog** - Navigation dans le catalogue
- **DealsCorner** - Promotions et bonnes affaires

---

## üì¶ Module Product

**Namespace**: `App\Product`
**Table**: `Domain\Table\Product`
**Entity**: `Domain\Entity\Product`

### Description

Gestion des produits g√©n√©riques de la plateforme. Support de diff√©rents types de produits via le pattern Strategy.

### Actions

#### Read
**Fichier**: `App/Product/Read.php`
**Route**: `GET /:slug-:id`

Affiche le d√©tail d'un produit.

```php
final class Read extends AppAction {
    public function __invoke(): void {
        $queries = $this->getRequest()->getQueryParams();
        $id = (int)$queries['id'];

        $this->_table = new Product($this->_setDb());
        $product = $this->_table->read($id);

        // Application d'une strat√©gie selon le type
        $strategy = match($product->behavior_type) {
            'Graphics' => new Types\Graphics($this->_route),
            'PlateStickers' => new Types\PlateStickers($this->_route),
            'AccessoryStickers' => new Types\AccessorySticker($this->_route),
            'EngineGuard' => new Types\EngineGuard($this->_route),
            default => new Types\Basics($this->_route)
        };

        $strategy->setProduct($product);
        $this->_middleware = $strategy;
        $this->handle($this->getRequest());
    }
}
```

#### Gallery
**Fichier**: `App/Product/Gallery.php`
**Route**: `GET /products/:id/gallery`

R√©cup√®re la galerie d'images d'un produit.

#### Options
**Fichier**: `App/Product/Options.php`
**Route**: `GET /products/:id/options`

R√©cup√®re les options de personnalisation.

#### AddToCart
**Fichier**: `App/Product/AddToCart.php`
**Route**: `POST /product/add-to-cart`

Ajoute un produit au panier.

### Types de produits (Strategies)

#### Graphics
**Fichier**: `App/Product/Types/Graphics.php`

Gestion des kits graphiques pour v√©hicules.

**Sp√©cificit√©s**:
- Personnalisation couleurs
- Num√©ros de course
- Templates par v√©hicule

#### PlateStickers
**Fichier**: `App/Product/Types/PlateStickers.php`

Autocollants de plaques.

**Sp√©cificit√©s**:
- Personnalisation num√©ro
- Choix couleurs
- Format de plaque

#### Basics
**Fichier**: `App/Product/Types/Basics.php`

Produits standards sans personnalisation sp√©ciale.

### Entity

`Domain/Entity/Product.php`

Propri√©t√©s calcul√©es via lazy loading :
- `cost` - Prix format√© avec devise
- `amount` - Prix num√©rique avec TVA
- `title` - Titre avec fallback traduction
- `url` - URL du produit
- `description` - Description traduite

### Table

`Domain/Table/Product.php`

M√©thodes principales :
- `findAll()` - Liste tous les produits
- `read($id)` - Lit un produit par ID
- `readBySlug($slug)` - Lit par slug
- `findByCategory($categoryId)` - Produits par cat√©gorie
- `findRelated($productId, $limit)` - Produits li√©s
- `search($term)` - Recherche texte

---

## üõí Module Cart

**Namespace**: `App\Cart`
**Table**: `Domain\Table\Cart`
**Entity**: `Domain\Entity\Cart`

### Description

Gestion compl√®te du panier d'achat avec items, quantit√©s, codes promo et calcul de totaux.

### Actions

#### Overview
**Fichier**: `App/Cart/Overview.php`
**Route**: `GET /checkout/cart-overview`

R√©cup√®re le contenu complet du panier.

```php
final class Overview extends AppAction {
    public function __invoke(): void {
        $cartId = $this->getCartId();

        $cartTable = new Cart($this->_setDb());
        $cart = $cartTable->getWithItems($cartId);

        $this->json([
            'cart' => $cart->toArray(),
            'items' => array_map(fn($i) => $i->toArray(), $cart->items)
        ]);
    }
}
```

#### UpdateItemQty
**Fichier**: `App/Cart/UpdateItemQty.php`
**Route**: `PUT /carts/:id/items/:item/qty`

Met √† jour la quantit√© d'un item.

#### DeleteItem
**Fichier**: `App/Cart/DeleteItem.php`
**Route**: `DELETE /carts/:id/items/:item`

Supprime un item du panier.

#### AddVoucher
**Fichier**: `App/Cart/AddVoucher.php`
**Route**: `PUT /carts/:id/add-voucher`

Applique un code promo.

#### DeleteVoucher
**Fichier**: `App/Cart/DeleteVoucher.php`
**Route**: `PUT /carts/:id/delete-voucher`

Retire un code promo.

### Entity

`Domain/Entity/Cart.php`

Propri√©t√©s :
- `id` - ID du panier
- `user_id` - ID utilisateur (null si guest)
- `session_id` - ID de session
- `total_amount` - Montant total
- `items` - Collection d'items
- `voucher_code` - Code promo appliqu√©
- `discount_amount` - Montant de r√©duction

M√©thodes :
- `addItem($product, $quantity, $options)` - Ajoute un item
- `removeItem($itemId)` - Retire un item
- `updateQuantity($itemId, $quantity)` - Met √† jour quantit√©
- `calculateTotal()` - Recalcule le total
- `applyVoucher($code)` - Applique un code promo
- `isEmpty()` - V√©rifie si vide

### Table

`Domain/Table/Cart.php`

M√©thodes :
- `getOrCreate($sessionId)` - R√©cup√®re ou cr√©e un panier
- `getWithItems($cartId)` - R√©cup√®re avec items
- `addItem($cartId, $data)` - Ajoute un item
- `updateItemQty($itemId, $quantity)` - Met √† jour quantit√©
- `deleteItem($itemId)` - Supprime un item
- `applyVoucher($cartId, $code)` - Applique code promo
- `clearVoucher($cartId)` - Retire code promo

---

## üí≥ Module Checkout

**Namespace**: `App\Checkout`
**Table**: `Domain\Table\Checkout`

### Description

Processus complet de commande en plusieurs √©tapes : panier ‚Üí exp√©dition ‚Üí paiement ‚Üí confirmation.

### Actions

#### Cart
**Fichier**: `App/Checkout/Cart.php`
**Route**: `GET /checkout/cart`

Affiche la page panier (√©tape 1).

#### Shipping
**Fichier**: `App/Checkout/Shipping.php`
**Route**: `GET /checkout/shipping`

Affiche la page de s√©lection de livraison (√©tape 2).

#### Payment
**Fichier**: `App/Checkout/Payment.php`
**Route**: `GET /checkout/pay`

Affiche la page de paiement (√©tape 3).

#### Create
**Fichier**: `App/Checkout/Create.php`
**Route**: `POST /checkout/:order/:psp`

Cr√©e la commande et initialise le paiement.

```php
final class Create extends AppAction {
    public function __invoke(int $order, string $psp): void {
        $body = $this->getRequest()->getParsedBody();

        // Validation
        $this->validate($body);

        // Cr√©ation de la commande
        $checkoutTable = new Checkout($this->_setDb());
        $orderId = $checkoutTable->createOrder($body);

        // Initialisation du paiement
        $paymentService = $this->getPaymentService($psp);
        $payment = $paymentService->initialize($orderId, $body);

        $this->json([
            'success' => true,
            'order' => $checkoutTable->getOrder($orderId),
            'payment' => $payment
        ]);
    }
}
```

#### Capture
**Fichier**: `App/Checkout/Capture.php`
**Route**: `POST /checkout/:order/:psp/capture`

Capture/confirme le paiement.

#### MapboxPoints
**Fichier**: `App/Checkout/MapboxPoints.php`
**Route**: `GET /cart/stores`

R√©cup√®re les points de retrait (Click & Collect).

### Workflow de commande

```
1. Cart (Panier)
   ‚Üì
2. Shipping (Adresse + mode livraison)
   ‚Üì
3. Payment (Moyen de paiement)
   ‚Üì
4. Create Order (Cr√©ation commande)
   ‚Üì
5. Payment Processing (Traitement paiement)
   ‚Üì
6. Capture (Confirmation)
   ‚Üì
7. Confirmation (Page de remerciement)
```

### Table

`Domain/Table/Checkout.php`

M√©thodes :
- `createOrder($data)` - Cr√©e une commande
- `getOrder($orderId)` - R√©cup√®re une commande
- `updateStatus($orderId, $status)` - Met √† jour le statut
- `calculateShipping($cartId, $method)` - Calcule frais de port
- `validateAddress($address)` - Valide une adresse
- `getShippingMethods()` - R√©cup√®re modes de livraison
- `getPaymentMethods()` - R√©cup√®re moyens de paiement

---

## ü™ë Module SaddleCover

**Namespace**: `App\SaddleCover`
**Table**: `Domain\Table\SaddleCover`
**Entity**: `Domain\Entity\SaddleCover`

### Description

Gestion des housses de selle personnalis√©es pour motos, quads, jetskis et motoneiges.

### Actions

#### Index
**Fichier**: `App/SaddleCover/Index.php`
**Route**: `GET /housses-de-selle` (FR), `/seat-covers` (EN)

Liste les housses de selle avec filtres.

#### Read
**Fichier**: `App/SaddleCover/Read.php`
**Route**: `GET /:section/:slug-:id`

D√©tail d'une housse de selle.

#### Filter
**Fichier**: `App/SaddleCover/Filter.php`
**Route**: `GET /:slug/filters`

R√©cup√®re les filtres disponibles.

#### RefreshFilter
**Fichier**: `App/SaddleCover/RefreshFilter.php`
**Route**: `GET /:slug/refresh-filters`

Rafra√Æchit les filtres selon s√©lections.

#### AddToCart
**Fichier**: `App/SaddleCover/AddToCart.php`
**Route**: `POST /:slug`

Ajoute une housse au panier.

#### Export
**Fichier**: `App/SaddleCover/Export.php`
**Route**: `GET /:slug/export`

Exporte le catalogue (CSV/PDF).

### Filtrage

Syst√®me de filtrage dynamique :
- Marque de v√©hicule
- Mod√®le
- Ann√©e/Mill√©sime
- Type (Moto, Quad, Jetski, Snowmobile)

### Entity

`Domain/Entity/SaddleCover.php`

Propri√©t√©s sp√©cifiques :
- `vehicle_brand` - Marque du v√©hicule
- `vehicle_model` - Mod√®le
- `year` - Ann√©e
- `reference` - R√©f√©rence produit
- `compatibility` - Compatibilit√© v√©hicules

---

## üëï Module Sportswear

**Namespace**: `App\Sportswear`
**Table**: `Domain\Table\Sportswear`

### Description

V√™tements de sport personnalisables (maillots, pantalons, gants).

### Actions

#### Read
**Fichier**: `App/Sportswear/Read.php`
**Route**: `GET /sportswear/:slug-:id`

D√©tail d'un v√™tement.

#### AddToCart
**Fichier**: `App/Sportswear/AddToCart.php`
**Route**: `POST /sportswear`

Ajoute un v√™tement personnalis√© au panier.

### Personnalisation

Options disponibles :
- Taille (XS, S, M, L, XL, XXL, XXXL)
- Couleurs primaire/secondaire
- Texte personnalis√©
- Num√©ro
- Logo/Sponsors

---

## üèç Module Vehicle

**Namespace**: `App\Vehicle`
**Table**: `Domain\Table\Vehicle`

### Description

Catalogue de v√©hicules (motos, quads, jetskis, motoneiges) pour associer aux produits.

### Actions

#### GraphicYears
**Fichier**: `App/Vehicle/GraphicYears.php`
**Route**: `GET /vehicle/:id/years`

R√©cup√®re les ann√©es disponibles pour un v√©hicule.

#### YearKitTypes
**Fichier**: `App/Vehicle/YearKitTypes.php`
**Route**: `GET /vehicle-years/:id/kit-types`

Types de kits pour une ann√©e.

#### YearTypes
**Fichier**: `App/Vehicle/YearTypes.php`
**Route**: `GET /vehicles/:id/years/:year_id/year-types`

Gabarits/types pour v√©hicule + ann√©e.

### Hi√©rarchie

```
Vehicle (Yamaha YZ250F)
  ‚îú‚îÄ‚îÄ Year (2024)
  ‚îÇ   ‚îú‚îÄ‚îÄ YearType (Standard)
  ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ KitType (Kit Complet 16 pi√®ces)
  ‚îÇ   ‚îî‚îÄ‚îÄ YearType (Factory Edition)
  ‚îÇ       ‚îî‚îÄ‚îÄ KitType (Kit FE 16 pi√®ces)
  ‚îî‚îÄ‚îÄ Year (2023)
      ‚îî‚îÄ‚îÄ YearType (Standard)
          ‚îî‚îÄ‚îÄ KitType (Kit Complet 16 pi√®ces)
```

---

## üìÑ Module Page

**Namespace**: `App\Page`
**Table**: `Domain\Table\Page`

### Description

Syst√®me CMS pour pages de contenu statiques et dynamiques.

### Actions

#### Homepage
**Fichier**: `App/Page/Homepage.php`
**Route**: `GET /`

Page d'accueil.

#### Read
**Fichier**: `App/Page/Read.php`
**Route**: `GET /:slug`

Affiche une page de contenu.

### Fonctionnalit√©s

- Templates personnalisables
- Multi-langue
- SEO (meta title, description)
- Widgets int√©grables
- Statut (draft/published)

---

## üè∑ Module Category

**Namespace**: `App\Category`
**Table**: `Domain\Table\Category`

### Description

Gestion des cat√©gories de produits avec hi√©rarchie parent/enfant.

### Structure

Cat√©gories hi√©rarchiques :

```
Graphics
  ‚îú‚îÄ‚îÄ Motos
  ‚îÇ   ‚îú‚îÄ‚îÄ Motocross
  ‚îÇ   ‚îî‚îÄ‚îÄ Enduro
  ‚îú‚îÄ‚îÄ Quads
  ‚îî‚îÄ‚îÄ Jetskis

Housses de selle
  ‚îú‚îÄ‚îÄ Motos
  ‚îî‚îÄ‚îÄ Quads

Sportswear
  ‚îú‚îÄ‚îÄ Maillots
  ‚îú‚îÄ‚îÄ Pantalons
  ‚îî‚îÄ‚îÄ Gants
```

---

## üìö Module Catalog

**Namespace**: `App\Catalog`
**Table**: `Domain\Table\Catalog`

### Description

Navigation et recherche dans le catalogue de produits.

### Fonctionnalit√©s

- Listing avec filtres
- Tri (prix, popularit√©, nouveaut√©s)
- Pagination
- Recherche full-text
- Filtres multi-crit√®res

---

## üí∞ Module DealsCorner

**Namespace**: `App\DealsCorner`
**Table**: `Domain\Table\DealsCorner`

### Description

Gestion des promotions et bonnes affaires.

### Fonctionnalit√©s

- Produits en promotion
- Ventes flash
- Codes promo
- Bundles/Packs
- Outlet

---

## üß© Cr√©ation d'un nouveau module

### Template

```php
<?php
declare(strict_types=1);
namespace App\MonModule;

use App\AppAction;
use Domain\Table\MonModule as MonModuleTable;

final class Index extends AppAction {

    private MonModuleTable $_table;

    public function __invoke(): void {
        // 1. Initialisation
        $this->_table = new MonModuleTable($this->_setDb());

        // 2. R√©cup√©ration donn√©es
        $items = $this->_table->findAll();

        // 3. Rendu
        $this->render('MonModule/index', [
            'items' => $items,
            'title' => 'Mon Module'
        ]);
    }
}
```

### Checklist

- [ ] Cr√©er namespace `App/MonModule/`
- [ ] Cr√©er les Actions (Index, Read, Create, etc.)
- [ ] Cr√©er Entity `Domain/Entity/MonModule.php`
- [ ] Cr√©er Table `Domain/Table/MonModule.php`
- [ ] Cr√©er les vues `View/MonModule/`
- [ ] Ajouter les routes dans `webroot/index.php`
- [ ] Cr√©er les tables SQL
- [ ] Ajouter les tests
- [ ] Documenter dans MODULES.md

---

## üìä Statistiques des modules

| Module | Actions | Routes | Tables DB | Complexit√© |
|--------|---------|--------|-----------|------------|
| Product | 5 | 4 | 2 | Moyenne |
| Cart | 5 | 5 | 2 | Moyenne |
| Checkout | 6 | 6 | 3 | √âlev√©e |
| SaddleCover | 6 | 6 | 3 | √âlev√©e |
| Sportswear | 2 | 2 | 2 | Faible |
| Vehicle | 3 | 3 | 2 | Moyenne |
| Page | 2 | 2 | 2 | Faible |
| Category | 2 | 2 | 1 | Faible |
| Catalog | 3 | 3 | 1 | Moyenne |
| DealsCorner | 4 | 4 | 2 | Moyenne |

---

## üîó D√©pendances entre modules

```
Product
  ‚îú‚îÄ‚îÄ Category (relation)
  ‚îî‚îÄ‚îÄ Cart (ajout au panier)

Cart
  ‚îú‚îÄ‚îÄ Product (items)
  ‚îî‚îÄ‚îÄ Checkout (conversion)

Checkout
  ‚îú‚îÄ‚îÄ Cart (source)
  ‚îî‚îÄ‚îÄ Order (cr√©ation)

SaddleCover
  ‚îú‚îÄ‚îÄ Vehicle (compatibilit√©)
  ‚îî‚îÄ‚îÄ Product (h√©ritage)

Sportswear
  ‚îî‚îÄ‚îÄ Product (h√©ritage)

Vehicle
  ‚îî‚îÄ‚îÄ SaddleCover (relation)
  ‚îî‚îÄ‚îÄ Product/Graphics (relation)
```

---

**Maintenu par**: √âquipe Kutvek
**Derni√®re mise √† jour**: Octobre 2024
